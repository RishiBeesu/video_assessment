<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Modern Guided Walkthrough with TTS</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
    <!-- Add these to your <head> section -->
    <link rel="manifest" href="manifest.json">

    <!-- iOS specific -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Android specific -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">

    <!-- Add homescreen icons for Android -->
    <link rel="icon" sizes="192x192" href="icon-192.png">
    <link rel="icon" sizes="512x512" href="icon-512.png">

    <link rel="stylesheet" href="style.css">

</head>

<body>
    <div class="walkthrough-container">
        <!-- Instruction Panel with Progress Bar -->
        <div class="instruction-panel">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <p class="instruction-text" id="instructionText">
                <strong>Living Room/Hall</strong>
            </p>
        </div>


        <!-- Video Container -->
        <div class="video-container">
            <video id="videoElement" playsinline autoplay muted></video>
            <div class="processing-overlay" id="processingOverlay">
                <div class="analyzing-pulse"></div>
                <div class="loading-spinner"></div>
                <div class="loading-text">Analyzing your photo...</div>
                <img id="thumbnailPreview" class="thumbnail-preview" src="" alt="Captured photo">
            </div>

            <div class="record-indicator">
                <div class="record-dot"></div>
                <span>Recording</span>
            </div>
        </div>
        <!-- Update the thumbnail gallery with integrated counter -->
        <div class="thumbnail-gallery" id="thumbnailGallery">
            <div class="gallery-header">
                <span id="photoCount">0</span>/3 Photos
            </div>
            <!-- Thumbnails will be added here dynamically -->
        </div>

        <!-- Controls -->
        <div class="controls-container">
            <button id="languageButton" class="language-button">
                <i class="fas fa-language"></i> EN
            </button>
            <button id="feedbackButton" class="feedback-button">
                <i class="fas fa-camera"></i> Take Photo
            </button>
            <button id="openMenuButton" class="menu-button bottom-right">
                <i class="fas fa-th"></i>
            </button>
        </div>

        <!-- Add this language dropdown menu that will appear on click -->
        <div class="language-dropdown" id="languageDropdown">
            <button data-lang="english" class="lang-option active">English</button>
            <button data-lang="hinglish" class="lang-option">Hinglish</button>
            <button data-lang="kanglish" class="lang-option">Kanglish</button>
        </div>

        <div class="transition-screen" id="transitionScreen">
            <div class="transition-content">
                <div class="transition-icon">
                    <i class="fas fa-arrow-right"></i>
                </div>
                <h2 class="transition-text" id="transitionText">Now go to...</h2>
            </div>
        </div>
    </div>

    <!-- Task Menu -->
    <div class="task-menu" id="taskMenu">
        <div class="task-menu-header">
            <h2 class="task-menu-title">Property Walkthrough</h2>
            <button id="closeMenuButton" class="close-btn">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="task-menu-filter">
            <button class="active" id="showAllTasks">All Tasks</button>
            <button id="showRequiredTasks">Required Only</button>
        </div>
        <div class="task-progress">
            <div class="task-progress-text">
                <span id="completedRequired">0</span>/<span id="totalRequired">0</span> Required Tasks Completed
            </div>
            <div class="progress-container">
                <div class="progress-bar" id="taskProgressBar"></div>
            </div>

        </div>
        <div class="task-grid" id="taskGrid">
            <!-- Tasks will be generated here -->
        </div>
        <button id="completeWalkthrough" class="complete-walkthrough">
            <i class="fas fa-check-circle"></i> Complete Walkthrough
        </button>
    </div>

    <!-- Status Banner -->
    <div class="status-banner" id="acceptedBanner">
        <i class="fas fa-check-circle"></i> Accepted
    </div>

    <!-- AI Response Container -->
    <div id="aiResponseContainer" class="ai-response-container">
        <button class="close-response" id="closeResponse">Ã—</button>
        <div class="ai-response-header">
            <div class="ai-avatar">AI</div>
            <h3>AI Assistant</h3>
        </div>
        <div class="ai-response-content" id="aiResponseContent">
            <div id="loadingIndicator">
                <span class="loading-indicator"></span> Analyzing your view...
            </div>
            <p id="aiResponseText" class="ai-response-text"></p>
            <img id="capturedFrame" class="captured-frame" style="display:none;">
            <div class="audio-controls">
                <button id="toggleAudio" class="toggle-audio">
                    <i class="fas fa-volume-up"></i>
                </button>
                <audio id="ttsAudio" style="display: none;"></audio>
            </div>
            <button id="retakeButton" class="action-button retake-button" style="display:none;">
                <i class="fas fa-redo"></i> Take Another Photo
            </button>
            <div class="image-gallery" id="aiResponseGallery">
                <!-- Images will be added here dynamically -->
            </div>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        // ------------------------------
        // Helper & Global Variables
        // ------------------------------
        const testServerConnection = () => {
            fetch('http://localhost:3000/walkthroughs', {
                headers: {
                    'Authorization': 'Bearer dummy_token'
                }
            })
                .then(response => {
                    if (response.ok) {
                        console.log('âœ… Successfully connected to API server!');
                        return response.json();
                    }
                    throw new Error('Network response was not ok');
                })
                .then(data => {
                    console.log('ðŸ“¦ Server response:', data);
                })
                .catch(error => {
                    console.error('âŒ Error connecting to API server:', error);
                });
        };
        
        const data = await fetch("/api/get-key")
        data = await data.json()
        const OPENAI_API_KEY = data.key
        console.log(OPENAI_API_KEY)

        let allTasks = [];
        let currentTaskIndex = -1; // No current task selected initially
        let currentImageData = null;
        let geoLocationData = null;
        let deviceOrientationData = null;
        let imageUploadQueue = [];
        // Store images for each task
        let taskImagesMap = {};
        let selectedLanguage = 'english'; // Default language

        // DOM elements
        const els = {
            video: document.getElementById('videoElement'),
            feedbackBtn: document.getElementById('feedbackButton'),
            aiContainer: document.getElementById('aiResponseContainer'),
            aiText: document.getElementById('aiResponseText'),
            capturedFrame: document.getElementById('capturedFrame'),
            loading: document.getElementById('loadingIndicator'),
            closeBtn: document.getElementById('closeResponse'),
            instructionText: document.getElementById('instructionText'),
            progressBar: document.getElementById('progressBar'),
            banner: document.getElementById('acceptedBanner'),
            retakeBtn: document.getElementById('retakeButton'),
            toggleAudio: document.getElementById('toggleAudio'),
            ttsAudio: document.getElementById('ttsAudio'),
            transitionScreen: document.getElementById('transitionScreen'),
            transitionText: document.getElementById('transitionText'),
            // New Elements for Task Menu
            taskMenu: document.getElementById('taskMenu'),
            openMenuBtn: document.getElementById('openMenuButton'),
            closeMenuBtn: document.getElementById('closeMenuButton'),
            showAllTasks: document.getElementById('showAllTasks'),
            showRequiredTasks: document.getElementById('showRequiredTasks'),
            taskGrid: document.getElementById('taskGrid'),
            completeWalkthrough: document.getElementById('completeWalkthrough'),
            completedRequired: document.getElementById('completedRequired'),
            totalRequired: document.getElementById('totalRequired'),
            taskProgressBar: document.getElementById('taskProgressBar'),
            languageSelect: document.getElementById('languageSelect')

        };

        let stream = null;
        let currentFeedback = null;
        let showingOnlyRequired = false;

        // ------------------------------
        // Functions
        // ------------------------------

        // Load tasks data from JSON file
        const loadTasksData = async () => {
            try {
                const response = await fetch('walkthrough-config.json');
                if (!response.ok) {
                    throw new Error('Failed to load configuration');
                }
                const config = await response.json();

                // Map configuration to tasks
                allTasks = config.locations.map(location => ({
                    id: location.id || generateId(location.name),
                    name: location.name,
                    icon: location.icon || getIconForName(location.name),
                    isRequired: location.isRequired !== undefined ? location.isRequired : true,
                    isCompleted: false,
                    order: location.order || 999,
                    verificationGuidelines: location.verificationGuidelines || ""
                }));

                // Sort tasks by order
                allTasks.sort((a, b) => a.order - b.order);
                updateTaskMenu();
                updateRequiredTasksCount();
                openTaskMenu();
                currentTaskIndex = -1;
                updateInstructionText("Please select a task from the menu");

                console.log('Loaded configuration:', allTasks);
            } catch (error) {
                console.error('Error loading configuration:', error);
                alert('Failed to load walkthrough configuration. Please refresh and try again.');
            }
        };

        // Generate a unique ID from a name
        const generateId = (name) => {
            return name.toLowerCase().replace(/[^a-z0-9]/g, '-');
        };
        // Get language elements
        const languageButton = document.getElementById('languageButton');
        const languageDropdown = document.getElementById('languageDropdown');
        const langOptions = document.querySelectorAll('.lang-option');

        // Toggle language dropdown
        languageButton.addEventListener('click', () => {
            languageDropdown.classList.toggle('visible');
        });

        // Handle language selection
        langOptions.forEach(option => {
            option.addEventListener('click', function () {
                // Update active class
                langOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');

                // Update selected language
                selectedLanguage = this.dataset.lang;

                // Update button text
                const langCode = selectedLanguage === 'english' ? 'EN' :
                    selectedLanguage === 'hinglish' ? 'HI' : 'KA';
                languageButton.innerHTML = `<i class="fas fa-language"></i> ${langCode}`;

                // Hide dropdown
                languageDropdown.classList.remove('visible');

                // Show toast message
                showToast(`Language changed to ${this.textContent}`);
            });
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!languageButton.contains(event.target) && !languageDropdown.contains(event.target)) {
                languageDropdown.classList.remove('visible');
            }
        });

        // Initialize geolocation and device orientation tracking
        const initLocationAndOrientation = () => {
            // Geolocation tracking
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        geoLocationData = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy,
                            timestamp: new Date().toISOString()
                        };
                        console.log('Geolocation updated:', geoLocationData);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        geoLocationData = null;
                    },
                    {
                        enableHighAccuracy: true,
                        maximumAge: 30000,
                        timeout: 27000
                    }
                );
            }

            // Device orientation tracking
            if (window.DeviceOrientationEvent) {
                if (DeviceOrientationEvent.requestPermission &&
                    typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const permBtn = document.createElement('button');
                    permBtn.innerText = 'Enable Compass';
                    permBtn.className = 'permission-button';
                    permBtn.addEventListener('click', async () => {
                        try {
                            const permission = await DeviceOrientationEvent.requestPermission();
                            if (permission === 'granted') {
                                window.addEventListener('deviceorientation', handleOrientation);
                                permBtn.remove();
                            }
                        } catch (error) {
                            console.error('Orientation permission error:', error);
                        }
                    });
                    document.body.appendChild(permBtn);
                } else {
                    window.addEventListener('deviceorientation', handleOrientation);
                }
            }
        };
        const updateThumbnailGallery = (taskIndex) => {
            const gallery = document.getElementById('thumbnailGallery');
            // Clear gallery but preserve the header
            gallery.innerHTML = '<div class="gallery-header"><span id="photoCount">0</span>/3 Photos</div>';

            // Get the current task's images
            const task = allTasks[taskIndex];
            const images = taskImagesMap[task.id] || [];

            // Add existing images
            images.forEach((img, index) => {
                const thumbItem = document.createElement('div');
                thumbItem.className = 'thumbnail-item';
                thumbItem.innerHTML = `
            <img src="${img.dataUrl}" alt="Photo ${index + 1}">
            <div class="remove-photo">
                <i class="fas fa-times"></i>
            </div>
        `;

                // Add remove functionality
                thumbItem.querySelector('.remove-photo').addEventListener('click', () => {
                    removePhoto(taskIndex, index);
                });

                gallery.appendChild(thumbItem);
            });

            // Add empty placeholders if less than 3 photos
            const remaining = 3 - images.length;
            for (let i = 0; i < remaining; i++) {
                const emptyThumb = document.createElement('div');
                emptyThumb.className = 'thumbnail-item empty';
                emptyThumb.innerHTML = `<i class="fas fa-plus"></i>`;
                gallery.appendChild(emptyThumb);
            }

            // Update the counter
            document.getElementById('photoCount').textContent = images.length;

            // Update button state
            if (images.length >= 3) {
                els.feedbackBtn.classList.add('photos-complete');
                els.feedbackBtn.classList.remove('photos-remaining');
                els.feedbackBtn.innerHTML = '<i class="fas fa-check"></i> Next Task';
            } else {
                els.feedbackBtn.classList.remove('photos-complete');
                els.feedbackBtn.classList.add('photos-remaining');
                els.feedbackBtn.innerHTML = '<i class="fas fa-camera"></i> Take Photo';
            }
        }
        
        // Handler for device orientation events
        const handleOrientation = (event) => {
            const alpha = event.alpha;
            let heading = null;
            if ('webkitCompassHeading' in event) {
                heading = event.webkitCompassHeading;
            } else if (event.absolute) {
                heading = 360 - alpha;
            } else {
                heading = alpha;
            }

            deviceOrientationData = {
                heading: heading,
                beta: event.beta,
                gamma: event.gamma,
                timestamp: new Date().toISOString()
            };
        };

        // Get a suitable icon for the location
        const getIconForName = (name) => {
            const iconMap = {
                'kitchen': 'utensils',
                'bathroom': 'bath',
                'bedroom': 'bed',
                'living room': 'couch',
                'dining room': 'coffee',
                'garage': 'car',
                'entrance': 'door-open',
                'garden': 'tree',
                'balcony': 'cloud-sun',
                'exterior': 'home',
                'basement': 'dungeon',
                'attic': 'warehouse',
                'parking': 'parking',
                'hallway': 'door-closed',
                'toilet': 'toilet',
                'stairway': 'stairs',
                'laundry': 'tshirt'
            };

            const lowercaseName = name.toLowerCase();
            for (const [key, value] of Object.entries(iconMap)) {
                if (lowercaseName.includes(key)) {
                    return value;
                }
            }
            return 'camera';
        };

        // Set current task and update UI
        const setCurrentTask = (index) => {
            currentTaskIndex = index;
            if (index >= 0 && index < allTasks.length) {
                updateInstructionText(
                    allTasks[index].name,
                    allTasks[index].verificationGuidelines
                );
                updateThumbnailGallery(index);
            }
        }
        // Update the task menu with current task status
        const updateTaskMenu = () => {
            els.taskGrid.innerHTML = '';

            const tasksToShow = showingOnlyRequired
                ? allTasks.filter(task => task.isRequired)
                : allTasks;

            tasksToShow.forEach((task, index) => {
                const isNextSuggested = !task.isCompleted &&
                    (currentTaskIndex === -1 ||
                        (allTasks[currentTaskIndex].isCompleted &&
                            index === allTasks.findIndex(t => !t.isCompleted)));

                const taskElement = document.createElement('div');
                taskElement.className = `task-item ${task.isRequired ? 'required' : 'optional'} ${task.isCompleted ? 'completed' : ''} ${isNextSuggested ? 'next-suggested' : ''}`;
                taskElement.dataset.index = index;

                taskElement.innerHTML = `
                <div class="task-icon">
                    <i class="fas fa-${task.icon}"></i>
                </div>
                <p class="task-name">${task.name}</p>
                <div class="task-status ${task.isRequired ? 'required' : 'optional'}">
                    ${task.isRequired ? 'Required' : 'Optional'}
                </div>
                ${task.isCompleted ? '<div class="task-check"><i class="fas fa-check"></i></div>' : ''}
            `;

                taskElement.addEventListener('click', () => {
                    setCurrentTask(index);
                    closeTaskMenu();
                });

                els.taskGrid.appendChild(taskElement);
            });

            const allRequiredCompleted = allTasks.filter(task => task.isRequired)
                .every(task => task.isCompleted);

            if (allRequiredCompleted) {
                els.completeWalkthrough.classList.add('enabled');
            } else {
                els.completeWalkthrough.classList.remove('enabled');
            }
        };

        // Update the required tasks count display
        const updateRequiredTasksCount = () => {
            const requiredTasks = allTasks.filter(task => task.isRequired);
            const completedRequired = requiredTasks.filter(task => task.isCompleted).length;

            els.completedRequired.textContent = completedRequired;
            els.totalRequired.textContent = requiredTasks.length;

            const progressPercent = requiredTasks.length > 0
                ? (completedRequired / requiredTasks.length) * 100
                : 0;
            els.taskProgressBar.style.width = progressPercent + "%";
        };

        // Open and close task menu
        const openTaskMenu = () => {
            els.taskMenu.classList.add('visible');
            updateTaskMenu();
        };

        const closeTaskMenu = () => {
            els.taskMenu.classList.remove('visible');
        };

        // Update instruction text with fade transition
        const updateInstructionText = (text, guidelines) => {
            els.instructionText.style.opacity = 0;
            setTimeout(() => {
                if (guidelines) {
                    els.instructionText.innerHTML = `
                <strong>${text || 'Please select a task from the menu'}</strong>
                <div class="guidelines-text">
                    ${guidelines}
                    <br>Please capture all four walls of the room and the ceiling/roof (minimum 3 photos).
                </div>
            `;
                } else {
                    els.instructionText.textContent = text || 'Please select a task from the menu';
                }
                els.instructionText.style.opacity = 1;
            }, 300);
            updateRequiredTasksCount();
        };

        // Analyze image using OpenAI API
        const analyzeImageWithAI = async (taskName, guidelines, imageDataArray) => {
            try {
                // Prepare all images for the API request
                const imageContents = imageDataArray.map((imageDataUrl, index) => {
                    const base64Image = imageDataUrl.split(',')[1];
                    return {
                        type: "image_url",
                        image_url: {
                            url: `data:image/jpeg;base64,${base64Image}`
                        }
                    };
                });
                // Language-specific instructions
                let languageInstruction = '';
                if (selectedLanguage === 'hinglish') {
                    languageInstruction = 'Provide your review ONLY in Hinglish language (mix of Hindi and English).';
                } else if (selectedLanguage === 'kanglish') {
                    languageInstruction = 'Provide your review ONLY in Kanglish language (mix of Kannada and English).';
                } else {
                    languageInstruction = 'Provide your review in clear English.';
                }

                // Create the prompt for multiple images
                const prompt = `Review these ${imageDataArray.length} images for a property walkthrough for getting loan from Optimo.
The images should collectively show: "${taskName}".
Verification guidelines: ${guidelines || "Ensure the images are clear, well-lit, and properly show the requested area."} 

The user was instructed to capture all four walls of the room and the ceiling/roof (minimum 5 photos).

Evaluate all images together as a set. Look for different angles and perspectives showing different walls of the same location.
${languageInstruction}

Determine if this set of images meets the requirements for this location.
Return your response in JSON format with these fields:
{
    "review": "Your detailed review in the selected language",
    "isGood": true/false,
    "improvement": "Short Suggestions for improvement if needed in the selected language"
}`;
                

                // Prepare the full message content array with text prompt first, then all images
                const messageContent = [
                    { type: "text", text: prompt },
                    ...imageContents
                ];

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini",
                        messages: [
                            {
                                role: "user",
                                content: messageContent
                            }
                        ],
                        response_format: { type: "json_object" }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API responded with status: ${response.status}, message: ${errorText}`);
                }

                const data = await response.json();
                console.log('OpenAI API response:', data);

                try {
                    const aiReview = JSON.parse(data.choices[0].message.content);
                    return aiReview;
                } catch (parseError) {
                    console.error('Error parsing JSON response:', parseError);
                    return {
                        review: "Unable to analyze the images",
                        hinglishReview: "Images ko analyze karne mein problem aa rahi hai",
                        isGood: false,
                        improvement: "Please try again with clearer images"
                    };
                }
            } catch (error) {
                console.error('Error analyzing images:', error);
                return {
                    review: "Error analyzing the images",
                    hinglishReview: "Images ko analyze karne mein error aa gaya",
                    isGood: false,
                    improvement: "Technical error. Please try again."
                };
            }
        };


        // Initialize camera
        const initCamera = async () => {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error("Camera API not supported in this browser or not over HTTPS.");
                }
                stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: "environment",
                        width: { ideal: window.innerWidth },
                        height: { ideal: window.innerHeight }
                    },
                    audio: false
                });
                els.video.srcObject = stream;
            } catch (error) {
                console.error('Camera error:', error);
                alert('Camera access failed. Please ensure you are using HTTPS and have given permission.');
            }
        };

        // Generate TTS using OpenAI API
        const generateTTS = async (text) => {
            try {
                // TTS instructions based on selected language
                let voiceInstructions = "Speak with a cheerful and positive tone.";

                if (selectedLanguage === 'hinglish') {
                    voiceInstructions = "Speak in Hinglish with a cheerful and positive tone.";
                } else if (selectedLanguage === 'kanglish') {
                    voiceInstructions = "Speak in Kanglish with a cheerful and positive tone, mixing Kannada and English.";
                }

                const response = await fetch('https://api.openai.com/v1/audio/speech', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${OPENAI_API_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "gpt-4o-mini-tts",
                        voice: "coral",
                        input: text,
                        response_format: "mp3",
                        speed: 1.0,
                        instructions: voiceInstructions
                    })
                });
                if (!response.ok) {
                    throw new Error(`API responded with status: ${response.status}`);
                }
                const audioBlob = await response.blob();
                const audioUrl = URL.createObjectURL(audioBlob);
                els.ttsAudio.src = audioUrl;
                return audioUrl;
            } catch (error) {
                console.error('Error generating TTS:', error);
                return null;
            }
        };

        // Capture and analyze image
        const captureAndAnalyze = async () => {
            if (currentTaskIndex < 0 || currentTaskIndex >= allTasks.length) {
                openTaskMenu();
                const toast = document.createElement('div');
                toast.className = 'toast-message';
                toast.textContent = 'Please select a task first';
                document.body.appendChild(toast);
                setTimeout(() => toast.classList.add('visible'), 10);
                setTimeout(() => {
                    toast.classList.remove('visible');
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
                return;
            }

            if (navigator.vibrate) navigator.vibrate(50);
            const processingOverlay = document.getElementById('processingOverlay');
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            const loadingText = processingOverlay.querySelector('.loading-text');

            const canvas = document.createElement('canvas');
            canvas.width = els.video.videoWidth;
            canvas.height = els.video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(els.video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);

            currentImageData = {
                dataUrl: imageDataUrl,
                taskId: allTasks[currentTaskIndex].id,
                taskName: allTasks[currentTaskIndex].name,
                captureTime: new Date().toISOString(),
                geoLocation: { ...geoLocationData },
                orientation: { ...deviceOrientationData },
                status: 'pending'
            };

            thumbnailPreview.src = imageDataUrl;
            processingOverlay.classList.add('visible');
            setTimeout(() => {
                thumbnailPreview.classList.add('visible');
            }, 300);

            els.feedbackBtn.disabled = true;
            els.feedbackBtn.style.opacity = '0.7';

            els.capturedFrame.src = imageDataUrl;
            els.capturedFrame.style.display = 'block';
            els.retakeBtn.style.display = 'none';

            try {
                const currentTask = allTasks[currentTaskIndex];
                loadingText.textContent = `Analyzing ${currentTask.name.toLowerCase()}...`;

                const aiReview = await analyzeImageWithAI(
                    imageDataUrl,
                    currentTask.name,
                    currentTask.verificationGuidelines
                );

                loadingText.textContent = "Generating voice response...";
                currentFeedback = {
                    text: aiReview.review,
                    good: aiReview.isGood
                };


                const audioUrl = await generateTTS(currentFeedback.text);

                els.aiContainer.classList.add('visible');
                els.loading.style.display = 'none';
                els.aiText.style.display = 'block';
                els.toggleAudio.style.display = 'block';
                els.aiText.textContent = currentFeedback.text;

                setTimeout(() => {
                    processingOverlay.classList.remove('visible');
                    thumbnailPreview.classList.remove('visible');
                    els.feedbackBtn.disabled = false;
                    els.feedbackBtn.style.opacity = '1';
                }, 500);

                els.ttsAudio.play();
                els.ttsAudio.onended = () => {
                    if (currentFeedback.good) {
                        acceptImage();
                    }
                };

                if (!currentFeedback.good) {
                    els.retakeBtn.style.display = 'flex';
                }
            } catch (error) {
                console.error('Error during image analysis or audio generation:', error);
                processingOverlay.classList.remove('visible');
                thumbnailPreview.classList.remove('visible');
                els.feedbackBtn.disabled = false;
                els.feedbackBtn.style.opacity = '1';
                els.aiContainer.classList.add('visible');
                els.loading.style.display = 'none';
                els.aiText.style.display = 'block';
                els.aiText.textContent = "Sorry, there was an error analyzing your image. Please try again.";
                els.retakeBtn.style.display = 'flex';
            }
        };

        const captureImage = async () => {
            if (currentTaskIndex < 0 || currentTaskIndex >= allTasks.length) {
                openTaskMenu();
                showToast('Please select a task first');
                return;
            }

            const currentTask = allTasks[currentTaskIndex];
            const taskId = currentTask.id;

            // Initialize the image array for this task if it doesn't exist
            if (!taskImagesMap[taskId]) {
                taskImagesMap[taskId] = [];
            }

            // Check if we already have 3 images
            if (taskImagesMap[taskId].length >= 3) {
                // We have enough images, proceed to analysis
                analyzeTaskImages();
                return;
            }

            if (navigator.vibrate) navigator.vibrate(50);

            // Capture the image
            const canvas = document.createElement('canvas');
            canvas.width = els.video.videoWidth;
            canvas.height = els.video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(els.video, 0, 0, canvas.width, canvas.height);
            const imageDataUrl = canvas.toDataURL('image/jpeg', 0.8);

            // Create image data object
            const imageData = {
                dataUrl: imageDataUrl,
                taskId: taskId,
                taskName: currentTask.name,
                captureTime: new Date().toISOString(),
                geoLocation: { ...geoLocationData },
                orientation: { ...deviceOrientationData },
                status: 'pending'
            };

            // Add to our collection
            taskImagesMap[taskId].push(imageData);

            // Show quick flash feedback
            const flashOverlay = document.createElement('div');
            flashOverlay.className = 'flash-overlay';
            document.querySelector('.video-container').appendChild(flashOverlay);
            setTimeout(() => flashOverlay.remove(), 300);

            // Update the UI
            updateThumbnailGallery(currentTaskIndex);

            // If we now have 3 images, change button text to "Analyze"
            if (taskImagesMap[taskId].length >= 3) {
                els.feedbackBtn.innerHTML = '<i class="fas fa-check"></i> Analyze Photos';
            }
        }

        const analyzeTaskImages = async () => {
            const currentTask = allTasks[currentTaskIndex];
            const taskId = currentTask.id;

            if (!taskImagesMap[taskId] || taskImagesMap[taskId].length < 3) {
                showToast('Please take at least 3 photos');
                return;
            }

            const processingOverlay = document.getElementById('processingOverlay');
            const loadingText = processingOverlay.querySelector('.loading-text');

            // Show the first image in the thumbnail preview
            const thumbnailPreview = document.getElementById('thumbnailPreview');
            thumbnailPreview.src = taskImagesMap[taskId][0].dataUrl;

            processingOverlay.classList.add('visible');
            setTimeout(() => {
                thumbnailPreview.classList.add('visible');
            }, 300);

            els.feedbackBtn.disabled = true;
            els.feedbackBtn.style.opacity = '0.7';

            // Display all images in the AI response
            const aiResponseGallery = document.getElementById('aiResponseGallery');
            aiResponseGallery.innerHTML = '';
            taskImagesMap[taskId].forEach(imgData => {
                const img = document.createElement('img');
                img.src = imgData.dataUrl;
                img.alt = 'Captured image';
                aiResponseGallery.appendChild(img);
            });

            try {
                loadingText.textContent = `Analyzing ${currentTask.name.toLowerCase()}...`;

                // Extract just the dataUrls from the image objects
                const imageDataUrls = taskImagesMap[taskId].map(img => img.dataUrl);

                // Call our updated function with all images
                const aiReview = await analyzeImageWithAI(
                    currentTask.name,
                    currentTask.verificationGuidelines,
                    imageDataUrls
                );

                loadingText.textContent = "Generating voice response...";
                currentFeedback = {
                    text: aiReview.review,
                    good: aiReview.isGood
                };
                const audioUrl = await generateTTS(currentFeedback.text);

                els.aiContainer.classList.add('visible');
                els.loading.style.display = 'none';
                els.aiText.style.display = 'block';
                els.toggleAudio.style.display = 'block';
                els.aiText.textContent = currentFeedback.text;

                setTimeout(() => {
                    processingOverlay.classList.remove('visible');
                    thumbnailPreview.classList.remove('visible');
                    els.feedbackBtn.disabled = false;
                    els.feedbackBtn.style.opacity = '1';
                }, 500);

                els.ttsAudio.play();
                els.ttsAudio.onended = () => {
                    if (currentFeedback.good) {
                        acceptImages();
                    }
                };

                if (!currentFeedback.good) {
                    els.retakeBtn.style.display = 'flex';
                }

            } catch (error) {
                console.error('Error during image analysis or audio generation:', error);
                processingOverlay.classList.remove('visible');
                thumbnailPreview.classList.remove('visible');
                els.feedbackBtn.disabled = false;
                els.feedbackBtn.style.opacity = '1';
                els.aiContainer.classList.add('visible');
                els.loading.style.display = 'none';
                els.aiText.style.display = 'block';
                els.aiText.textContent = "Sorry, there was an error analyzing your images. Please try again.";
                els.retakeBtn.style.display = 'flex';
            }
        }


        const showToast = (message) => {
            const toast = document.createElement('div');
            toast.className = 'toast-message';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('visible'), 10);
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        const removePhoto = (taskIndex, photoIndex) => {
            const task = allTasks[taskIndex];
            if (taskImagesMap[task.id] && taskImagesMap[task.id][photoIndex]) {
                taskImagesMap[task.id].splice(photoIndex, 1);
                updateThumbnailGallery(taskIndex);
            }
        }

        // Accept and mark image as completed
        const acceptImages = () => {
            els.aiContainer.classList.remove('visible');
            els.banner.classList.add('visible');

            const currentTask = allTasks[currentTaskIndex];
            const taskId = currentTask.id;

            if (taskImagesMap[taskId] && taskImagesMap[taskId].length >= 3) {
                // Mark all images as accepted
                taskImagesMap[taskId].forEach(imgData => {
                    imgData.status = 'accepted';
                    imageUploadQueue.push({ ...imgData });
                });

                uploadImages();

                // Mark task as completed
                allTasks[currentTaskIndex].isCompleted = true;
                updateRequiredTasksCount();
            }

            setTimeout(() => {
                els.banner.classList.remove('visible');
                const allRequiredCompleted = allTasks.filter(task => task.isRequired)
                    .every(task => task.isCompleted);
                openTaskMenu();
                if (allRequiredCompleted) {
                    generateTTS("Badhai ho! Aapne saare zaruri photos le liye hain. Aap walkthrough complete kar sakte hain ya phir baki optional photos bhi le sakte hain.");
                }
            }, 2000);
        }

        // Reject current image
        const rejectCurrentImage = () => {
            if (currentImageData) {
                currentImageData.status = 'rejected';
                imageUploadQueue.push({ ...currentImageData });
                uploadImages();
            }
            els.aiContainer.classList.remove('visible');
            els.ttsAudio.pause();
        };

        // Upload images to server
        const uploadImages = async () => {
            if (imageUploadQueue.length === 0 || !navigator.onLine) return;
            const currentQueue = [...imageUploadQueue];
            imageUploadQueue = [];
            try {
                const serverUrl = 'https://your-api-server.com/upload-walkthrough-images';
                const walkthroughId = localStorage.getItem('walkthroughId') || generateWalkthroughId();
                const payload = {
                    walkthroughId: walkthroughId,
                    propertyId: localStorage.getItem('propertyId') || 'unknown',
                    userId: localStorage.getItem('userId') || 'anonymous',
                    timestamp: new Date().toISOString(),
                    images: currentQueue
                };

                const response = await fetch(serverUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken') || ''}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                console.log('Successfully uploaded images:', currentQueue.length);
            } catch (error) {
                console.error('Failed to upload images:', error);
                imageUploadQueue = [...imageUploadQueue, ...currentQueue];
                setTimeout(uploadImages, 5000);
            }
        };

        // Generate a unique walkthrough ID
        const generateWalkthroughId = () => {
            const id = 'walkthrough_' + new Date().getTime() + '_' + Math.random().toString(36).substring(2, 10);
            localStorage.setItem('walkthroughId', id);
            return id;
        };

        // Complete the walkthrough
        const completeWalkthrough = () => {
            const allRequiredCompleted = allTasks.filter(task => task.isRequired)
                .every(task => task.isCompleted);

            if (!allRequiredCompleted) {
                alert("Please complete all required tasks before finishing the walkthrough.");
                return;
            }
            closeTaskMenu();
            els.instructionText.textContent = "Walkthrough Completed!";
            els.feedbackBtn.style.display = "none";
            els.openMenuBtn.style.display = "none";
            generateTTS("Badhai ho! Aapne property walkthrough successfully complete kar liya hai. Saare photos acche se capture ho gaye hain. Dhanyavaad!");
            const completionOverlay = document.createElement('div');
            completionOverlay.className = 'completion-overlay';
            completionOverlay.innerHTML = `
            <div class="completion-content">
                <div class="completion-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Walkthrough Complete!</h2>
                <p>Thank you for completing the property walkthrough.</p>
                <p>All required photos have been captured successfully.</p>
            </div>
        `;
            document.body.appendChild(completionOverlay);
        };

        // ------------------------------
        // Initialization Calls
        // ------------------------------
        console.log('DOM fully loaded - script starting');
        testServerConnection();
        initCamera();
        loadTasksData();
        initLocationAndOrientation();

        // Bind event listeners to UI elements
        els.feedbackBtn.addEventListener('click', captureImage);
        els.closeBtn.addEventListener('click', () => {
            els.aiContainer.classList.remove('visible');
            els.ttsAudio.pause();
        });
        els.retakeBtn.addEventListener('click', () => {
            els.aiContainer.classList.remove('visible');
            els.ttsAudio.pause();
        });
        els.toggleAudio.addEventListener('click', () => {
            if (els.ttsAudio.paused) {
                els.ttsAudio.play();
                els.toggleAudio.innerHTML = '<i class="fas fa-volume-up"></i>';
            } else {
                els.ttsAudio.pause();
                els.toggleAudio.innerHTML = '<i class="fas fa-volume-mute"></i>';
            }
        });
        els.openMenuBtn.addEventListener('click', openTaskMenu);
        els.closeMenuBtn.addEventListener('click', closeTaskMenu);
        els.showAllTasks.addEventListener('click', () => {
            showingOnlyRequired = false;
            els.showAllTasks.classList.add('active');
            els.showRequiredTasks.classList.remove('active');
            updateTaskMenu();
        });
        els.showRequiredTasks.addEventListener('click', () => {
            showingOnlyRequired = true;
            els.showRequiredTasks.classList.add('active');
            els.showAllTasks.classList.remove('active');
            updateTaskMenu();
        });
        els.completeWalkthrough.addEventListener('click', completeWalkthrough);

        // Update button labels
        els.feedbackBtn.innerHTML = '<i class="fas fa-camera"></i>';
        els.openMenuBtn.innerHTML = '<i class="fas fa-th"></i>';

        // ------------------------------
        // Processing Overlay Setup
        // ------------------------------
        const overlayHTML = `
        <div class="processing-overlay" id="processingOverlay">
            <div class="analyzing-pulse"></div>
            <div class="loading-spinner"></div>
            <div class="loading-text">Analyzing your photo...</div>
            <img id="thumbnailPreview" class="thumbnail-preview" src="" alt="Captured photo">
        </div>
    `;
        document.querySelector('.video-container').insertAdjacentHTML('beforeend', overlayHTML);
        
        // Add this to your event listeners section
        document.querySelectorAll('.lang-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                // Remove active class from all buttons
                document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                // Add active class to clicked button
                this.classList.add('active');
                // Update selected language
                selectedLanguage = this.dataset.lang;
                console.log('Language changed to:', selectedLanguage);

                // Show a toast to confirm language change
                showToast(`Language changed to ${selectedLanguage}`);
            });
        });

        // Inject processing overlay styles
        const styleElement = document.createElement('style');
        styleElement.textContent = `
        /* Processing Overlay Styles */
        .processing-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        
        .processing-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1.5s linear infinite;
            margin-bottom: 20px;
        }
        
        .loading-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            text-align: center;
            max-width: 80%;
            line-height: 1.4;
        }
        
        .analyzing-pulse {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.3);
            position: absolute;
            animation: pulse-analyzing 2s infinite;
        }
        
        @keyframes pulse-analyzing {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1.2); opacity: 0.4; }
            100% { transform: scale(0.8); opacity: 0.8; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .thumbnail-preview {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            border-radius: 8px;
            border: 3px solid white;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            z-index: 101;
            transform: scale(0);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        .thumbnail-preview.visible {
            transform: scale(1);
        }

        /* Completion Overlay Styles */
        .completion-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(52, 152, 219, 0.9);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            text-align: center;
        }
        
        .completion-content {
            background-color: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            color: #333;
        }
        
        .completion-icon {
            font-size: 60px;
            color: #27ae60;
            margin-bottom: 20px;
        }
        
        .completion-content h2 {
            margin: 0 0 20px;
            font-size: 24px;
        }
        
        .completion-content p {
            margin: 10px 0;
            line-height: 1.5;
        }
    `;
        document.head.appendChild(styleElement);

        // ------------------------------
        // Service Worker Registration
        // ------------------------------
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw-walkthrough.js')
                    .then(registration => {
                        console.log('ServiceWorker registered: ', registration);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }

        // Android fullscreen adjustments
        if (navigator.userAgent.match(/Android/)) {
            window.addEventListener('load', function () {
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen();
                    }
                    setTimeout(() => window.scrollTo(0, 1), 300);
                }
            });
            window.addEventListener('orientationchange', function () {
                setTimeout(() => window.scrollTo(0, 1), 300);
            });
        }

        // PWA install prompt handling
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches) {
                const installBanner = document.createElement('div');
                installBanner.className = 'install-banner';
                installBanner.innerHTML = `
                <p>Install for fullscreen experience</p>
                <button id="installBtn">Install</button>
                <button id="dismissInstallBtn">Ã—</button>
            `;
                document.body.appendChild(installBanner);
                document.getElementById('installBtn').addEventListener('click', () => {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                            installBanner.remove();
                        }
                        deferredPrompt = null;
                    });
                });
                document.getElementById('dismissInstallBtn').addEventListener('click', () => {
                    installBanner.remove();
                });
            }
        });
    });
</script>

</body>

</html>